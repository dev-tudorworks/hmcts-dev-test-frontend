{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}

{% extends "template.njk" %}

{% block content %}
  {{ govukBackLink({
    text: "Back to tasks",
    href: "/"
  }) }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-xl">{{ task.title }}</h1>
      
      {% if task.status != 'COMPLETED' and task.dueDate %}
        {% set isOverdue = task.isOverdue %}
        {% if isOverdue %}
          {{ govukWarningText({
            text: "This task is overdue",
            iconFallbackText: "Warning"
          }) }}
        {% endif %}
      {% endif %}

      {% set statusTag %}
        {% if task.status == 'TODO' %}
          {{ govukTag({ text: 'To Do', classes: 'govuk-tag--yellow' }) }}
        {% elif task.status == 'IN_PROGRESS' %}
          {{ govukTag({ text: 'In Progress', classes: 'govuk-tag--blue' }) }}
        {% elif task.status == 'COMPLETED' %}
          {{ govukTag({ text: 'Completed', classes: 'govuk-tag--green' }) }}
        {% elif task.status == 'CANCELLED' %}
          {{ govukTag({ text: 'Cancelled', classes: 'govuk-tag--grey' }) }}
        {% endif %}
      {% endset %}

      {{ govukSummaryList({
        rows: [
          {
            key: { text: "Title" },
            value: { text: task.title }
          },
          {
            key: { text: "Description" },
            value: { 
              html: task.description | replace('\n', '<br>') if task.description else 'No description provided'
            }
          },
          {
            key: { text: "Status" },
            value: { html: statusTag }
          },
          {
            key: { text: "Due Date" },
            value: { 
              html: (task.formattedDueDate + 
                    ((' <strong class="govuk-tag govuk-tag--red">OVERDUE</strong>') 
                     if task.isOverdue else '')) 
                     if task.dueDate else 'No due date set'
            }
          },
          {
            key: { text: "Created" },
            value: { text: task.formattedCreatedAt }
          },
          {
            key: { text: "Last Updated" },
            value: { text: task.formattedUpdatedAt }
          }
        ]
      }) }}

      <div class="govuk-button-group govuk-!-margin-top-6">
        {{ govukButton({
          text: "Edit Task",
          href: "/tasks/" + task.id + "/edit",
          classes: "govuk-button--secondary"
        }) }}

        <!-- Quick Status Update Buttons -->
        {% if task.status == 'TODO' %}
          <form method="post" action="/tasks/{{ task.id }}/status" style="display: inline;">
            {% from 'macros/csrf.njk' import csrfProtection %}
            {{ csrfProtection(csrfToken) }}
            <input type="hidden" name="status" value="IN_PROGRESS">
            {{ govukButton({
              text: "Start Task",
              classes: "govuk-button"
            }) }}
          </form>
        {% elif task.status == 'IN_PROGRESS' %}
          <form method="post" action="/tasks/{{ task.id }}/status" style="display: inline;">
            {% from 'macros/csrf.njk' import csrfProtection %}
            {{ csrfProtection(csrfToken) }}
            <input type="hidden" name="status" value="COMPLETED">
            {{ govukButton({
              text: "Complete Task",
              classes: "govuk-button"
            }) }}
          </form>
          <form method="post" action="/tasks/{{ task.id }}/status" style="display: inline;">
            {% from 'macros/csrf.njk' import csrfProtection %}
            {{ csrfProtection(csrfToken) }}
            <input type="hidden" name="status" value="TODO">
            {{ govukButton({
              text: "Move to To Do",
              classes: "govuk-button govuk-button--secondary"
            }) }}
          </form>
        {% elif task.status == 'COMPLETED' %}
          <form method="post" action="/tasks/{{ task.id }}/status" style="display: inline;">
            {% from 'macros/csrf.njk' import csrfProtection %}
            {{ csrfProtection(csrfToken) }}
            <input type="hidden" name="status" value="IN_PROGRESS">
            {{ govukButton({
              text: "Reopen Task",
              classes: "govuk-button govuk-button--secondary"
            }) }}
          </form>
        {% endif %}

        {% if task.status != 'CANCELLED' %}
          <form method="post" action="/tasks/{{ task.id }}/status" style="display: inline;"
                onsubmit="return confirm('Are you sure you want to cancel this task?')">
            {% from 'macros/csrf.njk' import csrfProtection %}
            {{ csrfProtection(csrfToken) }}
            <input type="hidden" name="status" value="CANCELLED">
            {{ govukButton({
              text: "Cancel Task",
              classes: "govuk-button govuk-button--warning"
            }) }}
          </form>
        {% endif %}

        <form method="post" action="/tasks/{{ task.id }}/delete" style="display: inline;"
              onsubmit="return confirm('Are you sure you want to delete this task? This action cannot be undone.')">
          {% from 'macros/csrf.njk' import csrfProtection %}
          {{ csrfProtection(csrfToken) }}
          {{ govukButton({
            text: "Delete Task",
            classes: "govuk-button govuk-button--warning"
          }) }}
        </form>
      </div>
    </div>

    <div class="govuk-grid-column-one-third">
      <h2 class="govuk-heading-m">Task Actions</h2>
      <p class="govuk-body-s">Quick actions for this task:</p>
      <ul class="govuk-list govuk-list--bullet govuk-body-s">
        <li><a href="/tasks/{{ task.id }}/edit" class="govuk-link">Edit task details</a></li>
        <li><a href="/" class="govuk-link">Back to all tasks</a></li>
        <li><a href="/tasks/create" class="govuk-link">Create new task</a></li>
        {% if task.status == 'COMPLETED' %}
          <li><a href="/tasks/filter/COMPLETED" class="govuk-link">View all completed tasks</a></li>
        {% elif task.status == 'IN_PROGRESS' %}
          <li><a href="/tasks/filter/IN_PROGRESS" class="govuk-link">View all in progress tasks</a></li>
        {% elif task.status == 'TODO' %}
          <li><a href="/tasks/filter/TODO" class="govuk-link">View all to do tasks</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
{% endblock %}